# 搜索优化实现计划

## 技术栈

- **前端**: Vue.js + uni-app
- **后端**: uniCloud + MongoDB
- **搜索**: MongoDB正则表达式查询
- **缓存**: uni-app本地存储

## 系统架构

### 当前架构问题
```
用户输入 → 前端过滤(loaded_scripts) → 显示结果
```

### 目标架构
```
用户输入 → 防抖处理 → API调用(listScripts?q=keyword) → 后端搜索(全库) → 返回结果 → 显示
```

## 实现步骤

### 1. 前端修改 (script-list.vue)

#### 修改搜索逻辑
- 将`onSearch()`方法从空实现改为触发API调用
- 添加搜索防抖机制
- 修改搜索状态管理

#### 状态管理优化
- 添加搜索模式标识
- 区分普通浏览模式和搜索模式
- 搜索时重置分页状态

#### UI优化
- 搜索时显示搜索状态提示
- 搜索结果为空时显示友好提示
- 添加搜索关键词高亮

### 2. 后端优化 (listScripts云函数)

#### 搜索查询优化
- 确认MongoDB正则查询性能
- 添加搜索相关度排序（标题权重高于作者）
- 优化查询字段投影

#### 性能优化
- 考虑添加数据库索引
- 缓存频繁搜索结果（可选）

### 3. 数据流设计

#### 搜索请求流程
1. 用户输入关键词
2. 防抖延迟300ms
3. 调用`fetchScripts({page: 1, q: keyword})`
4. 显示搜索结果
5. 支持搜索结果分页

#### 状态管理
```javascript
{
  searchKeyword: '',
  isSearchMode: false,
  searchResults: [],
  searchPage: 1,
  searchNoMore: false
}
```

## 文件修改清单

### 前端文件
- `xueran/pages/script-list/script-list.vue` - 主要修改文件

### 后端文件
- `xueran/uniCloud-aliyun/cloudfunctions/listScripts/index.js` - 可能需要性能优化

## 风险控制

### 性能风险
- 大数据量搜索可能导致响应慢
- 缓解方案：添加搜索索引、结果缓存、分页限制

### 用户体验风险
- 搜索响应慢影响体验
- 缓解方案：防抖加载状态、空状态处理

### 兼容性风险
- 修改搜索逻辑可能影响现有功能
- 缓解方案：保持原有API接口，渐进式修改

## 测试策略

### 单元测试
- 测试搜索防抖逻辑
- 测试API调用参数构造
- 测试搜索状态管理

### 集成测试
- 测试搜索功能完整流程
- 测试搜索结果准确性
- 测试边界情况处理

### 性能测试
- 测试搜索响应时间
- 测试大数据量搜索性能
- 测试并发搜索请求
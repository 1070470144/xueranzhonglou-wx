# Manual Test Procedures: US1 - 错误处理和作业状态跟踪

**User Story**: US1 - 批量选择文件夹并上传 (Priority: P1)
**Goal**: 验证错误处理机制和作业状态跟踪功能
**Focus**: 错误情况下的用户体验和后台状态管理

---

## 测试环境准备

### 测试数据
1. **无效 JSON 文件**: 语法错误、格式不正确的文件
2. **权限错误模拟**: 只读文件夹、网络中断模拟
3. **大文件测试**: 超过大小限制的文件
4. **重复内容**: 与现有剧本重复的文件

### 监控工具
- 浏览器开发者工具（Network/Console）
- uniCloud 控制台日志
- 数据库查询工具

---

## 测试场景 1: JSON 格式验证错误

### 测试步骤
1. **准备测试文件**
   - 创建包含语法错误的 JSON 文件
   - 创建缺少 `_meta` 对象的 JSON 文件
   - 创建空数组 JSON 文件

2. **执行上传**
   - 选择包含错误文件的文件夹
   - 启动上传流程
   - 观察错误检测和报告

3. **验证错误处理**
   - 无效文件应被标记为失败
   - 有效文件应继续处理
   - 错误消息应具体说明问题

4. **检查后台状态**
   - 作业状态应正确更新
   - 错误详情应记录到数据库
   - 日志应包含详细错误信息

### 预期结果
- ✅ 格式错误的 JSON 被正确识别
- ✅ 错误消息清晰易懂
- ✅ 部分失败不影响整体流程
- ✅ 后台状态准确反映实际情况

---

## 测试场景 2: 网络错误和重试机制

### 测试步骤
1. **模拟网络中断**
   - 在上传过程中断开网络连接
   - 观察重试行为
   - 恢复网络后验证继续处理

2. **验证重试逻辑**
   - 检查重试次数是否符合配置
   - 验证重试间隔时间
   - 确认最终失败处理

3. **检查状态同步**
   - 作业状态应反映网络问题
   - 前端应显示适当的错误状态
   - 用户应能理解当前状态

### 预期结果
- ✅ 网络错误触发重试机制
- ✅ 重试策略符合配置要求
- ✅ 用户界面正确显示错误状态
- ✅ 恢复后能继续处理

---

## 测试场景 3: 权限和文件系统错误

### 测试步骤
1. **测试文件权限**
   - 选择包含只读文件的文件夹
   - 选择权限受限的文件夹
   - 验证错误处理

2. **验证用户反馈**
   - 检查错误消息是否引导性
   - 确认是否有解决建议
   - 验证界面状态正确

3. **检查日志记录**
   - 权限错误应记录到系统日志
   - 错误详情应包含足够诊断信息

### 预期结果
- ✅ 权限错误正确检测和报告
- ✅ 用户得到清晰的错误反馈
- ✅ 系统日志包含诊断信息

---

## 测试场景 4: 作业状态跟踪

### 测试步骤
1. **监控作业生命周期**
   - 创建作业后检查初始状态
   - 观察状态变化（pending → running → completed）
   - 验证状态时间戳准确性

2. **验证进度更新**
   - 检查 successCount/failCount 实时更新
   - 验证进度百分比计算正确
   - 确认前端显示与后端同步

3. **测试作业查询**
   - 使用 getJob API 查询状态
   - 验证返回数据完整性
   - 检查历史作业可追溯

### 预期结果
- ✅ 作业状态准确反映处理进度
- ✅ 前后端状态保持同步
- ✅ 历史作业可查询和追溯

---

## 测试场景 5: 并发控制和资源管理

### 测试步骤
1. **测试并发限制**
   - 上传大量文件观察并发行为
   - 验证同时处理的请求数量
   - 检查资源使用情况

2. **验证批处理**
   - 观察批处理大小控制
   - 检查批间延迟
   - 验证内存使用合理

3. **测试取消操作**
   - 在处理过程中取消作业
   - 验证资源正确清理
   - 检查作业状态更新

### 预期结果
- ✅ 并发控制在合理范围内
- ✅ 批处理参数正确应用
- ✅ 取消操作清理资源
- ✅ 系统保持稳定

---

## 错误类型和处理策略

### 客户端错误
- **文件读取失败**: 显示文件不可访问
- **JSON 解析错误**: 显示具体语法错误位置
- **格式验证失败**: 说明缺少必要字段
- **大小超限**: 显示当前大小和限制

### 服务器端错误
- **数据库连接失败**: 重试机制，降级处理
- **脚本创建失败**: 记录具体失败原因
- **权限验证失败**: 明确权限错误信息
- **资源耗尽**: 适当的错误处理和用户提示

### 网络错误
- **连接超时**: 自动重试，指数退避
- **服务不可用**: 降级到离线模式或明确提示
- **请求被拒绝**: 检查权限和配额

---

## 性能监控点

### 响应时间指标
- 文件验证时间: < 100ms per file
- 单个文件处理时间: < 2秒
- 批处理延迟: < 500ms
- 作业状态查询: < 200ms

### 资源使用监控
- 内存增长: < 10MB per 100 files
- CPU 使用: 保持在合理范围内
- 网络请求数: 控制并发不超过配置

### 错误率监控
- 预期错误率: < 5% (正常操作)
- 异常错误率: 触发告警
- 重试成功率: > 80%

---

## 调试和诊断

### 日志检查点
- 客户端控制台错误
- 服务器端云函数日志
- 数据库操作日志
- 网络请求日志

### 诊断命令
```javascript
// 检查作业状态
const jobStatus = await uniCloud.callFunction({
  name: 'bulkUpload',
  data: { action: 'getJob', jobId: 'your-job-id' }
});

// 获取错误详情
const errors = await uniCloud.callFunction({
  name: 'bulkUpload',
  data: { action: 'getJobErrors', jobId: 'your-job-id' }
});
```

---

**测试负责人**: [测试人员姓名]
**最后更新**: 2026-01-15
**测试环境**: 开发环境 / H5 浏览器
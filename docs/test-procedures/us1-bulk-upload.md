# Manual Test Procedures: US1 - 批量选择文件夹并上传

**User Story**: US1 - 批量选择文件夹并上传 (Priority: P1)
**Goal**: 在剧本列表页实现批量上传入口，允许管理员选择本地文件夹（H5-only）或使用降级上传，构建 manifest 并创建后台作业
**Independent Test**: 在 H5 浏览器中选择一个包含 10 个 JSON 的目录，启动上传；验证所有文件被处理且在列表页出现对应记录或有明确错误报告

---

## 测试环境准备

### 测试数据准备
1. 创建一个测试文件夹 `test-scripts/` 包含 10 个有效的 Clocktower JSON 文件
2. 确保每个 JSON 文件包含：
   - `_meta` 对象作为第一个元素
   - 有效的 `name`, `author` 字段
   - 至少一个角色对象
3. 创建一个包含无效 JSON 的测试文件夹 `test-invalid/` 用于错误测试

### 浏览器环境
- 使用 Chrome 最新版本（推荐）
- 确保浏览器支持 `webkitdirectory` API
- 禁用所有扩展程序以避免干扰

---

## 测试场景 1: 基础文件夹选择和上传流程

### 前置条件
- 管理员已登录管理后台
- 位于剧本列表页面 `/pages/admin/scripts/list.vue`

### 测试步骤
1. **验证批量上传入口存在**
   - 在剧本列表页查找"批量上传"按钮
   - 按钮应位于页面顶部操作区域
   - 按钮样式应符合 Ant Design 规范

2. **点击批量上传按钮**
   - 点击"批量上传"按钮
   - 应弹出 `BulkUploadPanel.vue` 模态窗口
   - 窗口标题应为"批量上传剧本"

3. **选择文件夹**
   - 在模态窗口中点击"选择文件夹"按钮
   - 浏览器应打开文件夹选择对话框
   - 选择包含 10 个 JSON 文件的 `test-scripts/` 文件夹
   - 验证文件夹被接受且显示文件列表

4. **验证文件列表显示**
   - 模态窗口应显示选中的所有 JSON 文件
   - 每个文件应显示文件名、大小、状态
   - 文件计数应显示 "共 10 个文件"

5. **验证文件预览**
   - 点击任意文件行的预览按钮
   - 应弹出文件预览对话框
   - 显示 JSON 的 `_meta` 信息（名称、作者、描述等）

6. **开始上传**
   - 点击"开始上传"按钮
   - 模态窗口应显示上传进度
   - 进度条应从 0% 开始实时更新

7. **验证上传进度**
   - 观察进度条实时更新
   - 显示当前处理的文件名
   - 显示已处理/总文件数（如 "5/10"）

8. **等待上传完成**
   - 等待进度条达到 100%
   - 观察成功/失败统计
   - 验证完成摘要显示

9. **验证上传结果**
   - 检查列表页是否新增了 10 个剧本记录
   - 每个记录应包含正确的标题、作者信息
   - 记录应标记来源为批量上传作业

### 预期结果
- ✅ 所有 10 个有效 JSON 文件成功创建为剧本
- ✅ 剧本列表页面显示新记录
- ✅ 每个剧本包含正确的元数据
- ✅ 无 JavaScript 错误或 UI 异常

### 验收标准
- 文件选择对话框正常打开
- 文件列表正确显示所有选中的 JSON 文件
- 进度条实时更新且准确反映处理进度
- 上传完成后所有有效文件都成功创建为剧本记录

---

## 测试场景 2: 错误处理和失败情况

### 前置条件
- 包含 5 个有效 JSON 和 3 个无效 JSON 的测试文件夹

### 测试步骤
1. **选择包含错误文件的文件夹**
   - 使用包含无效 JSON 的测试文件夹
   - 启动上传流程

2. **观察错误处理**
   - 验证无效文件被标记为失败
   - 检查错误消息是否清晰描述问题
   - 验证有效文件仍然被处理

3. **验证最终结果**
   - 成功文件数应为 5
   - 失败文件数应为 3
   - 提供"下载失败详情"链接

4. **检查失败详情导出**
   - 点击"下载失败详情"按钮
   - 下载的 CSV/JSON 应包含文件名和具体错误信息
   - 错误信息应有助于用户修复问题

### 预期结果
- ✅ 有效文件成功上传
- ✅ 无效文件被正确识别和报告
- ✅ 错误详情可导出供用户查看
- ✅ 部分失败不影响整体流程

---

## 测试场景 3: 浏览器兼容性

### 测试浏览器
- Chrome (推荐)
- Firefox
- Safari (如果可用)
- Edge

### 测试步骤
1. **在不同浏览器中重复场景 1**
2. **验证文件夹选择功能**
   - Chrome: 应支持原生文件夹选择
   - Firefox: 可能需要降级到多文件选择
   - 其他浏览器: 验证降级方案正常工作

3. **验证上传流程一致性**
   - 所有浏览器应有相同的用户体验
   - 进度显示和错误处理应一致

### 预期结果
- ✅ 主要浏览器支持完整功能
- ✅ 降级方案在不支持的浏览器中正常工作
- ✅ 用户体验在不同浏览器中保持一致

---

## 测试场景 4: 大文件处理

### 前置条件
- 包含 50+ 个 JSON 文件的大文件夹
- 文件大小从几 KB 到几 MB

### 测试步骤
1. **选择大文件夹**
   - 选择包含大量文件的文件夹
   - 观察文件列表加载性能

2. **验证批处理**
   - 启动上传观察批处理行为
   - 验证并发控制（不应同时处理太多文件）
   - 检查内存使用是否合理

3. **验证长时间运行**
   - 上传过程不应导致页面冻结
   - UI 应保持响应（可取消操作）
   - 进度更新应及时

### 预期结果
- ✅ 大批量文件能稳定处理
- ✅ UI 保持响应不冻结
- ✅ 合理的内存使用
- ✅ 可随时取消操作

---

## 性能指标验证

### 响应时间
- 文件夹选择后文件列表显示: < 2秒
- 单个文件预览弹出: < 1秒
- 上传启动响应: < 500ms
- 整体上传完成时间: 与文件数量成比例，平均 < 30秒/10个文件

### 内存使用
- 页面内存增长: < 50MB 处理 100 个文件
- 无内存泄漏（刷新页面后内存恢复）

### 网络请求
- 并发请求数控制在合理范围内（默认 3-5）
- 失败请求自动重试
- 网络错误有清晰提示

---

## 回归测试清单

每次代码变更后执行：

- [ ] 文件夹选择对话框正常打开
- [ ] 文件列表正确加载和显示
- [ ] 进度条实时更新
- [ ] 上传成功后记录出现在列表中
- [ ] 错误情况正确处理和报告
- [ ] 取消操作正常工作
- [ ] 浏览器兼容性保持

---

## 测试数据清理

每次测试完成后：

1. 删除测试创建的剧本记录
2. 清理 bulkUploadJobs 集合中的测试作业
3. 清理相关日志记录
4. 重置测试环境

---

**测试负责人**: [测试人员姓名]
**最后更新**: 2026-01-15
**测试环境**: 开发环境 / H5 浏览器
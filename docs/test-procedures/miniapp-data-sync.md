# 小程序端数据结构统一与同步 - 测试流程

**测试目标**: 验证小程序端与管理端数据结构统一，确保持有界面正常显示管理端数据

**测试范围**:
- 数据字段完整性验证
- 前端数据映射正确性
- 界面显示一致性
- 数据同步及时性

## 前置条件

### 环境准备
1. HBuilderX 开发环境已配置
2. uniCloud 云服务环境可用
3. 测试数据库包含完整字段的剧本数据

### 测试数据准备
1. 在 HBuilderX 中打开项目
2. 运行 `xueran/uniCloud-aliyun/database/JQL查询.jql` 插入测试数据
3. 确认数据库中至少有 3 条包含完整字段的剧本记录

## 测试流程

### 测试用例 1: 云函数字段扩展验证

**目的**: 验证云函数能正确返回管理端完整字段

**步骤**:
1. 在 HBuilderX 中打开云函数调试面板
2. 测试 `listScripts` 云函数：
   ```javascript
   // 请求参数
   { page: 1, pageSize: 10 }

   // 预期响应包含管理端字段
   {
     code: 0,
     data: [{
      id: "...",
      title: "经典狼人杀剧本 - 数据结构测试",
      author: "官方出品",
      status: "active",
      tag: "推理",
       description: "...",
       updateTime: 1704067200000,
       usageCount: 1250,
       // ... 其他管理端字段
     }],
     total: 3
   }
   ```

3. 测试 `getScript` 云函数：
   ```javascript
   // 请求参数
   { id: "test_script_id" }

   // 预期响应包含详情字段
   {
     code: 0,
     data: [{
       id: "...",
       title: "...",
       content: "...",
       fileId: "...",
       fileUrl: "...",
       // ... 所有管理端字段
     }]
   }
   ```

**验收标准**:
- ✅ 云函数返回数据包含所有管理端字段
- ✅ 字段值与数据库存储一致
- ✅ 无字段缺失或类型错误

### 测试用例 2: 小程序列表页面数据映射

**目的**: 验证列表页面正确处理和管理端数据字段

**步骤**:
1. 运行小程序到 H5 环境
2. 访问剧本列表页面 (`/pages/script-list/script-list`)
3. 观察数据加载和显示

**验证点**:
- ✅ 剧本标题和作者正确显示
- ✅ 点赞数正确显示 (显示管理端 likes 字段)
- ✅ 图片正常加载 (支持 thumbnails 降级)
- ✅ 版本信息正确显示 (有默认值处理)
- ✅ 无 JavaScript 控制台错误

**验收标准**:
- ✅ 所有剧本记录正常显示
- ✅ 字段映射正确 (支持单值 `tag`，兼容旧数据 `tags` 数组)
- ✅ 默认值正确应用
- ✅ 界面响应正常

### 测试用例 3: 小程序详情页面数据映射

**目的**: 验证详情页面正确显示管理端完整数据

**步骤**:
1. 在列表页面点击任意剧本
2. 进入详情页面 (`/pages/script-detail/script-detail`)
3. 验证所有字段的显示

**验证点**:
- ✅ 剧本标题、作者、版本正确显示
- ✅ 描述内容正确显示 (管理端 description 字段)
- ✅ 游戏信息正确显示 (playerCount, difficulty, usageCount, tag)
- ✅ 更新时间正确显示 (管理端 updateTime 字段)
- ✅ 点赞数正确显示
- ✅ 图片轮播正常工作
- ✅ JSON地址链接正确 (fileUrl 字段)

**验收标准**:
- ✅ 所有管理端字段正确映射到界面
- ✅ 数据类型转换正确 (数组转字符串等)
- ✅ 默认值处理正确
- ✅ 界面布局完整

### 测试用例 4: 数据同步及时性验证

**目的**: 验证小程序能及时获取管理端数据更新

**步骤**:
1. 在管理端更新一条剧本数据 (修改标题或描述)
2. 在小程序端执行下拉刷新
3. 验证数据是否及时同步

**验证点**:
- ✅ 下拉刷新触发数据重新加载
- ✅ 最新数据在 3 秒内显示
- ✅ 数据变更完全同步
- ✅ 无缓存数据残留

**验收标准**:
- ✅ 数据同步延迟小于 3 秒
- ✅ 所有字段变更都能正确同步
- ✅ 界面状态正确更新

### 测试用例 5: 边界情况处理

**目的**: 验证系统对异常数据的处理能力

**测试场景**:
1. **缺失字段数据**:
   - 创建缺少某些字段的剧本记录
   - 验证默认值正确应用

2. **格式错误数据**:
  - `tag` 字段为数组或不存在时的兼容性检查
  - 验证转换逻辑正确处理单值 `tag` 或旧数据 `tags` 数组

3. **网络异常情况**:
   - 模拟网络断开
   - 验证错误提示和重试机制

**验收标准**:
- ✅ 系统稳定运行不崩溃
- ✅ 默认值正确应用
- ✅ 错误提示用户友好
- ✅ 数据恢复后功能正常

## 测试记录

### 测试环境信息
- **测试日期**: [YYYY-MM-DD]
- **测试人员**: [姓名]
- **HBuilderX 版本**: [版本号]
- **uni-app 版本**: [版本号]
- **测试设备**: [设备信息]

### 测试结果汇总

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 云函数字段扩展 | ⏳ 待测试 | - |
| 列表页面数据映射 | ⏳ 待测试 | - |
| 详情页面数据映射 | ⏳ 待测试 | - |
| 数据同步及时性 | ⏳ 待测试 | - |
| 边界情况处理 | ⏳ 待测试 | - |

### 发现的问题

#### 已知问题
- 无

#### 修复记录
- 无

## 性能基准

- **数据加载时间**: < 2秒
- **页面切换时间**: < 1秒
- **图片加载时间**: < 3秒
- **内存使用**: < 50MB

## 验收标准总结

**功能验收**:
- ✅ 小程序端显示与管理端数据完全一致
- ✅ 所有字段正确映射和转换
- ✅ 界面响应流畅无错误

**性能验收**:
- ✅ 数据刷新响应时间 < 3秒
- ✅ 页面加载时间 < 2秒
- ✅ 用户操作响应及时

**兼容性验收**:
- ✅ 支持管理端数据格式变更
- ✅ 向后兼容现有数据
- ✅ 错误处理完善

## 后续行动

1. **问题修复**: 根据测试发现的问题进行修复
2. **性能优化**: 如发现性能瓶颈进行优化
3. **文档更新**: 更新用户文档和API文档
4. **部署验证**: 在生产环境进行最终验证